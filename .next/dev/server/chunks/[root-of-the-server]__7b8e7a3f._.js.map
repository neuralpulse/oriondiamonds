{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/kushagraverma/Desktop/Neural%20Pulse/Oriondiamonds/src/app/api/cart/route.js"],"sourcesContent":["// src/app/api/cart/route.js\nimport { NextResponse } from \"next/server\";\nimport mongoose from \"mongoose\";\n\n// MongoDB connection\nlet isConnected = false;\n\nasync function connectDB() {\n  if (isConnected && mongoose.connection.readyState === 1) {\n    return;\n  }\n\n  try {\n    await mongoose.connect(process.env.MONGODB_URI, {\n      bufferCommands: false,\n    });\n    isConnected = true;\n    console.log(\"✅ MongoDB connected\");\n  } catch (error) {\n    console.error(\"❌ MongoDB connection error:\", error);\n    throw error;\n  }\n}\n\n// Cart Schema - stores the actual cart items\nconst CartSchema = new mongoose.Schema(\n  {\n    email: {\n      type: String,\n      required: true,\n      unique: true,\n      index: true,\n      lowercase: true,\n      trim: true,\n    },\n    items: [\n      {\n        variantId: { type: String, required: true },\n        handle: { type: String, required: true },\n        title: { type: String, required: true },\n        variantTitle: String,\n        image: String,\n        price: Number,\n        calculatedPrice: Number,\n        currencyCode: { type: String, default: \"INR\" },\n        quantity: { type: Number, required: true, min: 1 },\n        selectedOptions: [\n          {\n            name: String,\n            value: String,\n          },\n        ],\n        descriptionHtml: String,\n      },\n    ],\n  },\n  {\n    timestamps: true, // Adds createdAt and updatedAt\n  }\n);\n\nconst Cart = mongoose.models.Cart || mongoose.model(\"Cart\", CartSchema);\n\n/**\n * GET /api/cart?email=customer@email.com\n * Fetch cart items for customer\n */\nexport async function GET(request) {\n  try {\n    await connectDB();\n\n    const { searchParams } = new URL(request.url);\n    const email = searchParams.get(\"email\");\n\n    if (!email) {\n      return NextResponse.json({ error: \"Email required\" }, { status: 400 });\n    }\n\n    const cart = await Cart.findOne({ email: email.toLowerCase() });\n\n    return NextResponse.json({\n      success: true,\n      items: cart?.items || [],\n      itemCount: cart?.items?.length || 0,\n    });\n  } catch (error) {\n    console.error(\"Error fetching cart:\", error);\n    return NextResponse.json(\n      { error: \"Failed to fetch cart\", details: error.message },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/cart\n * Save/update entire cart for customer\n */\nexport async function POST(request) {\n  try {\n    await connectDB();\n\n    const { email, items } = await request.json();\n\n    if (!email) {\n      return NextResponse.json({ error: \"Email required\" }, { status: 400 });\n    }\n\n    if (!Array.isArray(items)) {\n      return NextResponse.json(\n        { error: \"Items must be an array\" },\n        { status: 400 }\n      );\n    }\n\n    // Validate items\n    const validItems = items.filter((item) => {\n      return (\n        item &&\n        item.variantId &&\n        item.handle &&\n        item.title &&\n        item.quantity &&\n        item.quantity > 0\n      );\n    });\n\n    if (validItems.length !== items.length) {\n      console.warn(\n        `Filtered out ${items.length - validItems.length} invalid items`\n      );\n    }\n\n    // Upsert (update or insert) cart\n    const cart = await Cart.findOneAndUpdate(\n      { email: email.toLowerCase() },\n      {\n        email: email.toLowerCase(),\n        items: validItems,\n      },\n      {\n        upsert: true,\n        new: true,\n        runValidators: true,\n      }\n    );\n\n    return NextResponse.json({\n      success: true,\n      itemCount: cart.items.length,\n      message: \"Cart saved successfully\",\n    });\n  } catch (error) {\n    console.error(\"Error saving cart:\", error);\n    return NextResponse.json(\n      { error: \"Failed to save cart\", details: error.message },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * PUT /api/cart/item\n * Add or update a single item in cart\n */\nexport async function PUT(request) {\n  try {\n    await connectDB();\n\n    const { email, item } = await request.json();\n\n    if (!email || !item) {\n      return NextResponse.json(\n        { error: \"Email and item required\" },\n        { status: 400 }\n      );\n    }\n\n    // Validate item\n    if (\n      !item.variantId ||\n      !item.handle ||\n      !item.title ||\n      !item.quantity ||\n      item.quantity < 1\n    ) {\n      return NextResponse.json({ error: \"Invalid item data\" }, { status: 400 });\n    }\n\n    const cart = await Cart.findOne({ email: email.toLowerCase() });\n\n    if (!cart) {\n      // Create new cart with this item\n      const newCart = await Cart.create({\n        email: email.toLowerCase(),\n        items: [item],\n      });\n\n      return NextResponse.json({\n        success: true,\n        itemCount: newCart.items.length,\n        message: \"Item added to new cart\",\n      });\n    }\n\n    // Check if item already exists\n    const existingItemIndex = cart.items.findIndex(\n      (i) => i.variantId === item.variantId\n    );\n\n    if (existingItemIndex > -1) {\n      // Update existing item\n      cart.items[existingItemIndex] = {\n        ...cart.items[existingItemIndex].toObject(),\n        ...item,\n      };\n    } else {\n      // Add new item\n      cart.items.push(item);\n    }\n\n    await cart.save();\n\n    return NextResponse.json({\n      success: true,\n      itemCount: cart.items.length,\n      message: \"Item added/updated successfully\",\n    });\n  } catch (error) {\n    console.error(\"Error updating cart item:\", error);\n    return NextResponse.json(\n      { error: \"Failed to update cart item\", details: error.message },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * DELETE /api/cart?email=customer@email.com\n * Clear entire cart for customer\n */\nexport async function DELETE(request) {\n  try {\n    await connectDB();\n\n    const { searchParams } = new URL(request.url);\n    const email = searchParams.get(\"email\");\n    const variantId = searchParams.get(\"variantId\");\n\n    if (!email) {\n      return NextResponse.json({ error: \"Email required\" }, { status: 400 });\n    }\n\n    if (variantId) {\n      // Remove specific item from cart\n      const cart = await Cart.findOne({ email: email.toLowerCase() });\n\n      if (!cart) {\n        return NextResponse.json({\n          success: true,\n          message: \"Cart not found\",\n        });\n      }\n\n      cart.items = cart.items.filter((item) => item.variantId !== variantId);\n      await cart.save();\n\n      return NextResponse.json({\n        success: true,\n        itemCount: cart.items.length,\n        message: \"Item removed from cart\",\n      });\n    } else {\n      // Clear entire cart\n      await Cart.deleteOne({ email: email.toLowerCase() });\n\n      return NextResponse.json({\n        success: true,\n        message: \"Cart cleared\",\n      });\n    }\n  } catch (error) {\n    console.error(\"Error deleting cart:\", error);\n    return NextResponse.json(\n      { error: \"Failed to delete cart\", details: error.message },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * PATCH /api/cart/quantity\n * Update item quantity\n */\nexport async function PATCH(request) {\n  try {\n    await connectDB();\n\n    const { email, variantId, quantity } = await request.json();\n\n    if (!email || !variantId || !quantity) {\n      return NextResponse.json(\n        { error: \"Email, variantId, and quantity required\" },\n        { status: 400 }\n      );\n    }\n\n    if (quantity < 1) {\n      return NextResponse.json(\n        { error: \"Quantity must be at least 1\" },\n        { status: 400 }\n      );\n    }\n\n    const cart = await Cart.findOne({ email: email.toLowerCase() });\n\n    if (!cart) {\n      return NextResponse.json({ error: \"Cart not found\" }, { status: 404 });\n    }\n\n    const itemIndex = cart.items.findIndex(\n      (item) => item.variantId === variantId\n    );\n\n    if (itemIndex === -1) {\n      return NextResponse.json({ error: \"Item not found\" }, { status: 404 });\n    }\n\n    cart.items[itemIndex].quantity = quantity;\n    await cart.save();\n\n    return NextResponse.json({\n      success: true,\n      message: \"Quantity updated\",\n    });\n  } catch (error) {\n    console.error(\"Error updating quantity:\", error);\n    return NextResponse.json(\n      { error: \"Failed to update quantity\", details: error.message },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}