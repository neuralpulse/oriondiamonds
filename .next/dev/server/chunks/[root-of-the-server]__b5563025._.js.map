{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 196, "column": 0}, "map": {"version":3,"sources":["file:///Users/kushagraverma/Desktop/Neural%20Pulse/Oriondiamonds/src/app/api/gold-price/route.js"],"sourcesContent":["// src/app/api/gold-price/route.js\nimport { NextResponse } from \"next/server\";\nimport * as cheerio from \"cheerio\";\n\n// In-memory cache\nlet priceCache = {\n  price24k: null,\n  lastFetchDate: null,\n  fetchTime: \"08:00\", // 8:00 AM IST\n};\n\n// Helper: Check if we should fetch new price\nfunction shouldFetchPrice() {\n  const now = new Date();\n  const istTime = new Date(\n    now.toLocaleString(\"en-US\", { timeZone: \"Asia/Kolkata\" })\n  );\n  const currentDate = istTime.toISOString().split(\"T\")[0];\n  const currentHour = istTime.getHours();\n\n  // If never fetched, fetch now\n  if (!priceCache.lastFetchDate) {\n    return true;\n  }\n\n  // If it's a new day and past 8 AM, fetch\n  if (currentDate > priceCache.lastFetchDate && currentHour >= 8) {\n    return true;\n  }\n\n  return false;\n}\n\n// Fetch 24K gold price from Groww Surat page\nasync function fetch24kPriceFromGroww() {\n  const url = \"https://groww.in/gold-rates/gold-rate-today-in-surat\";\n\n  try {\n    const response = await fetch(url, {\n      headers: {\n        \"User-Agent\":\n          \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`HTTP error! status: ${response.status}`);\n    }\n\n    const html = await response.text();\n    const $ = cheerio.load(html);\n\n    // Extract all text containing ₹ and numbers\n    const bodyText = $(\"body\").text();\n    const matches = bodyText.match(/₹\\s?([\\d,]+\\.?\\d*)/g);\n\n    if (matches) {\n      for (const match of matches) {\n        const priceStr = match.replace(/₹\\s?|,/g, \"\");\n        const price = parseFloat(priceStr);\n\n        // Validate realistic per gram gold price\n        if (price > 5000 && price < 20000) {\n          return price;\n        }\n      }\n    }\n\n    // Fallback: try to find elements with specific classes\n    const spans = $(\"span.bodyLargeHeavy\");\n    for (let i = 0; i < spans.length; i++) {\n      const text = $(spans[i]).text();\n      if (text.includes(\"₹\") || /\\d/.test(text)) {\n        const priceMatch = text.match(/₹?\\s?([\\d,]+\\.?\\d*)/);\n        if (priceMatch) {\n          const price = parseFloat(priceMatch[1].replace(/,/g, \"\"));\n          if (price > 5000 && price < 20000) {\n            return price;\n          }\n        }\n      }\n    }\n\n    throw new Error(\"Could not locate valid 24K price on Groww Surat page\");\n  } catch (error) {\n    console.error(\"Error fetching gold price:\", error);\n    throw error;\n  }\n}\n\n// Update cache with new price\nasync function updatePriceCache() {\n  try {\n    console.log(\"Fetching fresh gold price from Groww...\");\n    const price = await fetch24kPriceFromGroww();\n\n    const now = new Date();\n    const istTime = new Date(\n      now.toLocaleString(\"en-US\", { timeZone: \"Asia/Kolkata\" })\n    );\n\n    priceCache = {\n      price24k: price,\n      lastFetchDate: istTime.toISOString().split(\"T\")[0],\n      fetchTime: \"08:00\",\n    };\n\n    console.log(`✅ Price updated: ₹${price.toFixed(2)}/gram`);\n    return price;\n  } catch (error) {\n    console.error(\"Failed to update price cache:\", error);\n    throw error;\n  }\n}\n\n// GET endpoint\nexport async function GET() {\n  try {\n    // Check if we need to fetch new price\n    if (shouldFetchPrice()) {\n      await updatePriceCache();\n    }\n\n    // If still no price (e.g., first fetch failed), try again\n    if (!priceCache.price24k) {\n      await updatePriceCache();\n    }\n\n    const istTime = new Date(\n      new Date().toLocaleString(\"en-US\", { timeZone: \"Asia/Kolkata\" })\n    );\n\n    return NextResponse.json({\n      success: true,\n      city: \"Surat\",\n      price: Math.round(priceCache.price24k * 100) / 100,\n      unit: \"INR per gram\",\n      date: priceCache.lastFetchDate,\n      lastUpdated: istTime.toISOString(),\n      nextUpdate: \"Tomorrow at 8:00 AM IST\",\n    });\n  } catch (error) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: error.message || \"Failed to fetch gold price\",\n      },\n      { status: 500 }\n    );\n  }\n}\n\n// Force refresh endpoint (for manual updates)\nexport async function POST() {\n  try {\n    await updatePriceCache();\n\n    return NextResponse.json({\n      success: true,\n      message: \"Price cache updated successfully\",\n      price: priceCache.price24k,\n      date: priceCache.lastFetchDate,\n    });\n  } catch (error) {\n    return NextResponse.json(\n      {\n        success: false,\n        error: error.message || \"Failed to update price cache\",\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"AAAA,kCAAkC;;;;;;;AAClC;AACA;AAAA;;;AAEA,kBAAkB;AAClB,IAAI,aAAa;IACf,UAAU;IACV,eAAe;IACf,WAAW;AACb;AAEA,6CAA6C;AAC7C,SAAS;IACP,MAAM,MAAM,IAAI;IAChB,MAAM,UAAU,IAAI,KAClB,IAAI,cAAc,CAAC,SAAS;QAAE,UAAU;IAAe;IAEzD,MAAM,cAAc,QAAQ,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;IACvD,MAAM,cAAc,QAAQ,QAAQ;IAEpC,8BAA8B;IAC9B,IAAI,CAAC,WAAW,aAAa,EAAE;QAC7B,OAAO;IACT;IAEA,yCAAyC;IACzC,IAAI,cAAc,WAAW,aAAa,IAAI,eAAe,GAAG;QAC9D,OAAO;IACT;IAEA,OAAO;AACT;AAEA,6CAA6C;AAC7C,eAAe;IACb,MAAM,MAAM;IAEZ,IAAI;QACF,MAAM,WAAW,MAAM,MAAM,KAAK;YAChC,SAAS;gBACP,cACE;YACJ;QACF;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YAChB,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,SAAS,MAAM,EAAE;QAC1D;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,MAAM,IAAI,iKAAY,CAAC;QAEvB,4CAA4C;QAC5C,MAAM,WAAW,EAAE,QAAQ,IAAI;QAC/B,MAAM,UAAU,SAAS,KAAK,CAAC;QAE/B,IAAI,SAAS;YACX,KAAK,MAAM,SAAS,QAAS;gBAC3B,MAAM,WAAW,MAAM,OAAO,CAAC,WAAW;gBAC1C,MAAM,QAAQ,WAAW;gBAEzB,yCAAyC;gBACzC,IAAI,QAAQ,QAAQ,QAAQ,OAAO;oBACjC,OAAO;gBACT;YACF;QACF;QAEA,uDAAuD;QACvD,MAAM,QAAQ,EAAE;QAChB,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,MAAM,EAAE,IAAK;YACrC,MAAM,OAAO,EAAE,KAAK,CAAC,EAAE,EAAE,IAAI;YAC7B,IAAI,KAAK,QAAQ,CAAC,QAAQ,KAAK,IAAI,CAAC,OAAO;gBACzC,MAAM,aAAa,KAAK,KAAK,CAAC;gBAC9B,IAAI,YAAY;oBACd,MAAM,QAAQ,WAAW,UAAU,CAAC,EAAE,CAAC,OAAO,CAAC,MAAM;oBACrD,IAAI,QAAQ,QAAQ,QAAQ,OAAO;wBACjC,OAAO;oBACT;gBACF;YACF;QACF;QAEA,MAAM,IAAI,MAAM;IAClB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,MAAM;IACR;AACF;AAEA,8BAA8B;AAC9B,eAAe;IACb,IAAI;QACF,QAAQ,GAAG,CAAC;QACZ,MAAM,QAAQ,MAAM;QAEpB,MAAM,MAAM,IAAI;QAChB,MAAM,UAAU,IAAI,KAClB,IAAI,cAAc,CAAC,SAAS;YAAE,UAAU;QAAe;QAGzD,aAAa;YACX,UAAU;YACV,eAAe,QAAQ,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YAClD,WAAW;QACb;QAEA,QAAQ,GAAG,CAAC,CAAC,kBAAkB,EAAE,MAAM,OAAO,CAAC,GAAG,KAAK,CAAC;QACxD,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,MAAM;IACR;AACF;AAGO,eAAe;IACpB,IAAI;QACF,sCAAsC;QACtC,IAAI,oBAAoB;YACtB,MAAM;QACR;QAEA,0DAA0D;QAC1D,IAAI,CAAC,WAAW,QAAQ,EAAE;YACxB,MAAM;QACR;QAEA,MAAM,UAAU,IAAI,KAClB,IAAI,OAAO,cAAc,CAAC,SAAS;YAAE,UAAU;QAAe;QAGhE,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;YACN,OAAO,KAAK,KAAK,CAAC,WAAW,QAAQ,GAAG,OAAO;YAC/C,MAAM;YACN,MAAM,WAAW,aAAa;YAC9B,aAAa,QAAQ,WAAW;YAChC,YAAY;QACd;IACF,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO,MAAM,OAAO,IAAI;QAC1B,GACA;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe;IACpB,IAAI;QACF,MAAM;QAEN,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT,OAAO,WAAW,QAAQ;YAC1B,MAAM,WAAW,aAAa;QAChC;IACF,EAAE,OAAO,OAAO;QACd,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO,MAAM,OAAO,IAAI;QAC1B,GACA;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}